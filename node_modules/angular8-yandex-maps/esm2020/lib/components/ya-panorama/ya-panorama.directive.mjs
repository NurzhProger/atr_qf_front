import { Directive, EventEmitter, Input, Output, } from '@angular/core';
import { from, Subject, takeUntil } from 'rxjs';
import { filter, map, switchMap, take } from 'rxjs/operators';
import { EventManager } from '../../event-manager/event-manager';
import * as i0 from "@angular/core";
import * as i1 from "../ya-map/ya-map.component";
/**
 * The `ya-panorama` component wraps `ymaps.panorama.Player` class from the Yandex.Maps API.
 * You can configure it via the component's inputs.
 * Events can be bound using the outputs of the component.
 *
 * @example
 * ```html
 * <ya-map>
 *   <ya-panorama [point]="[59.938557, 30.316198]" layer="yandex#airPanorama"></ya-panorama>
 * </ya-map>
 * ```
 */
export class YaPanoramaDirective {
    constructor(ngZone, yaMapComponent) {
        this.ngZone = ngZone;
        this.yaMapComponent = yaMapComponent;
        this.destroy$ = new Subject();
        this.eventManager = new EventManager(this.ngZone);
        /**
         * Panorama instance is created.
         */
        this.ready = new EventEmitter();
        /**
         * The player was closed by the user or destroyed using the panorama.Player.destroy method.
         * {@link https://yandex.com/dev/maps/jsapi/doc/2.1/ref/reference/panorama.Player.html#event_detail__event-destroy}
         */
        this.destroy = this.eventManager.getLazyEmitter('destroy');
        /**
         * The view direction changed.
         * {@link https://yandex.com/dev/maps/jsapi/doc/2.1/ref/reference/panorama.Player.html#event_detail__event-directionchange}
         */
        this.directionchange = this.eventManager.getLazyEmitter('directionchange');
        /**
         * An error occurred during operation of the player. The user will be shown the appropriate screen.
         * {@link https://yandex.com/dev/maps/jsapi/doc/2.1/ref/reference/panorama.Player.html#event_detail__event-error}
         */
        this.yaerror = this.eventManager.getLazyEmitter('error');
        /**
         * The panorama player switched to full-screen mode.
         * {@link https://yandex.com/dev/maps/jsapi/doc/2.1/ref/reference/panorama.Player.html#event_detail__event-fullscreenenter}
         */
        this.fullscreenenter = this.eventManager.getLazyEmitter('fullscreenenter');
        /**
         * The panorama player exited full-screen mode.
         * {@link https://yandex.com/dev/maps/jsapi/doc/2.1/ref/reference/panorama.Player.html#event_detail__event-fullscreenexit}
         */
        this.fullscreenexit = this.eventManager.getLazyEmitter('fullscreenexit');
        /**
         * The user clicked on an expanded marker.
         * {@link https://yandex.com/dev/maps/jsapi/doc/2.1/ref/reference/panorama.Player.html#event_detail__event-markercollapse}
         */
        this.markercollapse = this.eventManager.getLazyEmitter('markercollapse');
        /**
         * The user clicked on a collapsed marker.
         * {@link https://yandex.com/dev/maps/jsapi/doc/2.1/ref/reference/panorama.Player.html#event_detail__event-markerexpand}
         */
        this.markerexpand = this.eventManager.getLazyEmitter('markerexpand');
        /**
         * The user's cursor hovered over a marker.
         * {@link https://yandex.com/dev/maps/jsapi/doc/2.1/ref/reference/panorama.Player.html#event_detail__event-markermouseenter}
         */
        this.markermouseenter = this.eventManager.getLazyEmitter('markermouseenter');
        /**
         * The user's cursor left a marker.
         * {@link https://yandex.com/dev/maps/jsapi/doc/2.1/ref/reference/panorama.Player.html#event_detail__event-markermouseleave}
         */
        this.markermouseleave = this.eventManager.getLazyEmitter('markermouseleave');
        /**
         * The open panorama changed.
         * {@link https://yandex.com/dev/maps/jsapi/doc/2.1/ref/reference/panorama.Player.html#event_detail__event-panoramachange}
         */
        this.panoramachange = this.eventManager.getLazyEmitter('panoramachange');
        /**
         * The size of the viewport has been changed.
         * {@link https://yandex.com/dev/maps/jsapi/doc/2.1/ref/reference/panorama.Player.html#event_detail__event-spanchange}
         */
        this.spanchange = this.eventManager.getLazyEmitter('spanchange');
    }
    /**
     * Handles input changes and passes them in API.
     * @param changes
     */
    ngOnChanges(changes) {
        const { player } = this;
        if (player) {
            const { point, layer, options } = changes;
            /**
             * player.moveTo resets values to default if any of them isn't passed.
             * That's why we use value from currentValue OR previous value from input.
             * With that logic it's possible to pass only point, layer or options.
             */
            if (point || layer) {
                const combinedPoint = point?.currentValue || this.point;
                const combinedLayer = layer?.currentValue || this.layer;
                player.moveTo(combinedPoint, { layer: combinedLayer });
            }
            if (options) {
                this.setOptions(options.currentValue, player);
            }
        }
    }
    ngOnInit() {
        const panorama$ = this.yaMapComponent.map$.pipe(filter(Boolean), switchMap((m) => {
            // Map and panorama use the same container, so need to destroy/remove map
            m.destroy();
            return this.createPanorama();
        }));
        panorama$.pipe(take(1), takeUntil(this.destroy$)).subscribe((panorama) => {
            const { id } = this.yaMapComponent.container.nativeElement;
            const player = new ymaps.panorama.Player(id, panorama, this.options);
            this.player = player;
            this.eventManager.setTarget(player);
            this.ngZone.run(() => this.ready.emit({ ymaps, target: player }));
        });
    }
    ngOnDestroy() {
        this.eventManager.destroy();
        this.destroy$.next();
        this.destroy$.complete();
    }
    /**
     * Destructs state and passes it in API.
     * @param options
     * @param player
     */
    setOptions(options, player) {
        const { autoFitToViewport, controls, direction, hotkeysEnabled, span, scrollZoomBehavior, suppressMapOpenBlock, } = options;
        if (autoFitToViewport ||
            controls ||
            hotkeysEnabled ||
            scrollZoomBehavior ||
            suppressMapOpenBlock) {
            console.warn('Only direction and span can be set after entity init. To set other options, you should recreate a Panorama with new options');
        }
        if (direction) {
            player.setDirection(direction);
        }
        if (span) {
            player.setSpan(span);
        }
    }
    /**
     * Searches for a panorama and returns first
     */
    createPanorama() {
        return from(ymaps.panorama.locate(this.point, { layer: this.layer })).pipe(map((panoramas) => panoramas[0]));
    }
}
YaPanoramaDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.2.5", ngImport: i0, type: YaPanoramaDirective, deps: [{ token: i0.NgZone }, { token: i1.YaMapComponent }], target: i0.ɵɵFactoryTarget.Directive });
YaPanoramaDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "14.0.0", version: "14.2.5", type: YaPanoramaDirective, selector: "ya-panorama", inputs: { point: "point", layer: "layer", options: "options" }, outputs: { ready: "ready", destroy: "destroy", directionchange: "directionchange", yaerror: "yaerror", fullscreenenter: "fullscreenenter", fullscreenexit: "fullscreenexit", markercollapse: "markercollapse", markerexpand: "markerexpand", markermouseenter: "markermouseenter", markermouseleave: "markermouseleave", panoramachange: "panoramachange", spanchange: "spanchange" }, usesOnChanges: true, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.2.5", ngImport: i0, type: YaPanoramaDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: 'ya-panorama',
                }]
        }], ctorParameters: function () { return [{ type: i0.NgZone }, { type: i1.YaMapComponent }]; }, propDecorators: { point: [{
                type: Input
            }], layer: [{
                type: Input
            }], options: [{
                type: Input
            }], ready: [{
                type: Output
            }], destroy: [{
                type: Output
            }], directionchange: [{
                type: Output
            }], yaerror: [{
                type: Output
            }], fullscreenenter: [{
                type: Output
            }], fullscreenexit: [{
                type: Output
            }], markercollapse: [{
                type: Output
            }], markerexpand: [{
                type: Output
            }], markermouseenter: [{
                type: Output
            }], markermouseleave: [{
                type: Output
            }], panoramachange: [{
                type: Output
            }], spanchange: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoieWEtcGFub3JhbWEuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvYW5ndWxhcjgteWFuZGV4LW1hcHMvc3JjL2xpYi9jb21wb25lbnRzL3lhLXBhbm9yYW1hL3lhLXBhbm9yYW1hLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUNULFlBQVksRUFDWixLQUFLLEVBS0wsTUFBTSxHQUVQLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxJQUFJLEVBQWMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM1RCxPQUFPLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFOUQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLG1DQUFtQyxDQUFDOzs7QUFLakU7Ozs7Ozs7Ozs7O0dBV0c7QUFJSCxNQUFNLE9BQU8sbUJBQW1CO0lBNkc5QixZQUE2QixNQUFjLEVBQW1CLGNBQThCO1FBQS9ELFdBQU0sR0FBTixNQUFNLENBQVE7UUFBbUIsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBNUczRSxhQUFRLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztRQUUvQixpQkFBWSxHQUFHLElBQUksWUFBWSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQXNCOUQ7O1dBRUc7UUFDTyxVQUFLLEdBQXNELElBQUksWUFBWSxFQUVsRixDQUFDO1FBRUo7OztXQUdHO1FBQ08sWUFBTyxHQUNmLElBQUksQ0FBQyxZQUFZLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRTlDOzs7V0FHRztRQUNPLG9CQUFlLEdBQ3ZCLElBQUksQ0FBQyxZQUFZLENBQUMsY0FBYyxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFFdEQ7OztXQUdHO1FBQ08sWUFBTyxHQUNm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QyxDQUFDLENBQUMsQ0FBQyxDQUNqQyxDQUFDO0lBQ0osQ0FBQzs7Z0hBak5VLG1CQUFtQjtvR0FBbkIsbUJBQW1COzJGQUFuQixtQkFBbUI7a0JBSC9CLFNBQVM7bUJBQUM7b0JBQ1QsUUFBUSxFQUFFLGFBQWE7aUJBQ3hCOzBIQVlVLEtBQUs7c0JBQWIsS0FBSztnQkFNRyxLQUFLO3NCQUFiLEtBQUs7Z0JBTUcsT0FBTztzQkFBZixLQUFLO2dCQUtJLEtBQUs7c0JBQWQsTUFBTTtnQkFRRyxPQUFPO3NCQUFoQixNQUFNO2dCQU9HLGVBQWU7c0JBQXhCLE1BQU07Z0JBT0csT0FBTztzQkFBaEIsTUFBTTtnQkFPRyxlQUFlO3NCQUF4QixNQUFNO2dCQU9HLGNBQWM7c0JBQXZCLE1BQU07Z0JBT0csY0FBYztzQkFBdkIsTUFBTTtnQkFPRyxZQUFZO3NCQUFyQixNQUFNO2dCQU9HLGdCQUFnQjtzQkFBekIsTUFBTTtnQkFPRyxnQkFBZ0I7c0JBQXpCLE1BQU07Z0JBT0csY0FBYztzQkFBdkIsTUFBTTtnQkFPRyxVQUFVO3NCQUFuQixNQUFNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICBEaXJlY3RpdmUsXHJcbiAgRXZlbnRFbWl0dGVyLFxyXG4gIElucHV0LFxyXG4gIE5nWm9uZSxcclxuICBPbkNoYW5nZXMsXHJcbiAgT25EZXN0cm95LFxyXG4gIE9uSW5pdCxcclxuICBPdXRwdXQsXHJcbiAgU2ltcGxlQ2hhbmdlcyxcclxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgZnJvbSwgT2JzZXJ2YWJsZSwgU3ViamVjdCwgdGFrZVVudGlsIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IGZpbHRlciwgbWFwLCBzd2l0Y2hNYXAsIHRha2UgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG5pbXBvcnQgeyBFdmVudE1hbmFnZXIgfSBmcm9tICcuLi8uLi9ldmVudC1tYW5hZ2VyL2V2ZW50LW1hbmFnZXInO1xyXG5pbXBvcnQgeyBZYUV2ZW50IH0gZnJvbSAnLi4vLi4vbW9kZWxzL3lhLWV2ZW50JztcclxuaW1wb3J0IHsgWWFSZWFkeUV2ZW50IH0gZnJvbSAnLi4vLi4vbW9kZWxzL3lhLXJlYWR5LWV2ZW50JztcclxuaW1wb3J0IHsgWWFNYXBDb21wb25lbnQgfSBmcm9tICcuLi95YS1tYXAveWEtbWFwLmNvbXBvbmVudCc7XHJcblxyXG4vKipcclxuICogVGhlIGB5YS1wYW5vcmFtYWAgY29tcG9uZW50IHdyYXBzIGB5bWFwcy5wYW5vcmFtYS5QbGF5ZXJgIGNsYXNzIGZyb20gdGhlIFlhbmRleC5NYXBzIEFQSS5cclxuICogWW91IGNhbiBjb25maWd1cmUgaXQgdmlhIHRoZSBjb21wb25lbnQncyBpbnB1dHMuXHJcbiAqIEV2ZW50cyBjYW4gYmUgYm91bmQgdXNpbmcgdGhlIG91dHB1dHMgb2YgdGhlIGNvbXBvbmVudC5cclxuICpcclxuICogQGV4YW1wbGVcclxuICogYGBgaHRtbFxyXG4gKiA8eWEtbWFwPlxyXG4gKiAgIDx5YS1wYW5vcmFtYSBbcG9pbnRdPVwiWzU5LjkzODU1NywgMzAuMzE2MTk4XVwiIGxheWVyPVwieWFuZGV4I2FpclBhbm9yYW1hXCI+PC95YS1wYW5vcmFtYT5cclxuICogPC95YS1tYXA+XHJcbiAqIGBgYFxyXG4gKi9cclxuQERpcmVjdGl2ZSh7XHJcbiAgc2VsZWN0b3I6ICd5YS1wYW5vcmFtYScsXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBZYVBhbm9yYW1hRGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0LCBPbkNoYW5nZXMsIE9uRGVzdHJveSB7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBkZXN0cm95JCA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XHJcblxyXG4gIHByaXZhdGUgcmVhZG9ubHkgZXZlbnRNYW5hZ2VyID0gbmV3IEV2ZW50TWFuYWdlcih0aGlzLm5nWm9uZSk7XHJcblxyXG4gIHByaXZhdGUgcGxheWVyPzogeW1hcHMucGFub3JhbWEuUGxheWVyO1xyXG5cclxuICAvKipcclxuICAgKiBUaGUgcG9pbnQgZm9yIHNlYXJjaGluZyBmb3IgbmVhcmJ5IHBhbm9yYW1hcy5cclxuICAgKiB7QGxpbmsgaHR0cHM6Ly95YW5kZXguY29tL2Rldi9tYXBzL2pzYXBpL2RvYy8yLjEvcmVmL3JlZmVyZW5jZS9wYW5vcmFtYS5sb2NhdGUuaHRtbCNwYW5vcmFtYS5sb2NhdGVfX3BhcmFtLXBvaW50fVxyXG4gICAqL1xyXG4gIEBJbnB1dCgpIHBvaW50OiBudW1iZXJbXTtcclxuXHJcbiAgLyoqXHJcbiAgICogVGhlIGxheWVyIHRvIHNlYXJjaCBmb3IgcGFub3JhbWFzLlxyXG4gICAqIHtAbGluayBodHRwczovL3lhbmRleC5jb20vZGV2L21hcHMvanNhcGkvZG9jLzIuMS9yZWYvcmVmZXJlbmNlL3Bhbm9yYW1hLmxvY2F0ZS5odG1sI3Bhbm9yYW1hLmxvY2F0ZV9fcGFyYW0tb3B0aW9ucy5sYXllcn1cclxuICAgKi9cclxuICBASW5wdXQoKSBsYXllcjogeW1hcHMucGFub3JhbWEuTGF5ZXI7XHJcblxyXG4gIC8qKlxyXG4gICAqIFBsYXllciBvcHRpb25zLlxyXG4gICAqIHtAbGluayBodHRwczovL3lhbmRleC5jb20vZGV2L21hcHMvanNhcGkvZG9jLzIuMS9yZWYvcmVmZXJlbmNlL3Bhbm9yYW1hLlBsYXllci5odG1sI3Bhbm9yYW1hLlBsYXllcl9fcGFyYW0tb3B0aW9uc31cclxuICAgKi9cclxuICBASW5wdXQoKSBvcHRpb25zOiB5bWFwcy5wYW5vcmFtYS5JUGxheWVyT3B0aW9ucztcclxuXHJcbiAgLyoqXHJcbiAgICogUGFub3JhbWEgaW5zdGFuY2UgaXMgY3JlYXRlZC5cclxuICAgKi9cclxuICBAT3V0cHV0KCkgcmVhZHk6IEV2ZW50RW1pdHRlcjxZYVJlYWR5RXZlbnQ8eW1hcHMucGFub3JhbWEuUGxheWVyPj4gPSBuZXcgRXZlbnRFbWl0dGVyPFxyXG4gICAgWWFSZWFkeUV2ZW50PHltYXBzLnBhbm9yYW1hLlBsYXllcj5cclxuICA+KCk7XHJcblxyXG4gIC8qKlxyXG4gICAqIFRoZSBwbGF5ZXIgd2FzIGNsb3NlZCBieSB0aGUgdXNlciBvciBkZXN0cm95ZWQgdXNpbmcgdGhlIHBhbm9yYW1hLlBsYXllci5kZXN0cm95IG1ldGhvZC5cclxuICAgKiB7QGxpbmsgaHR0cHM6Ly95YW5kZXguY29tL2Rldi9tYXBzL2pzYXBpL2RvYy8yLjEvcmVmL3JlZmVyZW5jZS9wYW5vcmFtYS5QbGF5ZXIuaHRtbCNldmVudF9kZXRhaWxfX2V2ZW50LWRlc3Ryb3l9XHJcbiAgICovXHJcbiAgQE91dHB1dCgpIGRlc3Ryb3k6IE9ic2VydmFibGU8WWFFdmVudDx5bWFwcy5wYW5vcmFtYS5QbGF5ZXI+PiA9XHJcbiAgICB0aGlzLmV2ZW50TWFuYWdlci5nZXRMYXp5RW1pdHRlcignZGVzdHJveScpO1xyXG5cclxuICAvKipcclxuICAgKiBUaGUgdmlldyBkaXJlY3Rpb24gY2hhbmdlZC5cclxuICAgKiB7QGxpbmsgaHR0cHM6Ly95YW5kZXguY29tL2Rldi9tYXBzL2pzYXBpL2RvYy8yLjEvcmVmL3JlZmVyZW5jZS9wYW5vcmFtYS5QbGF5ZXIuaHRtbCNldmVudF9kZXRhaWxfX2V2ZW50LWRpcmVjdGlvbmNoYW5nZX1cclxuICAgKi9cclxuICBAT3V0cHV0KCkgZGlyZWN0aW9uY2hhbmdlOiBPYnNlcnZhYmxlPFlhRXZlbnQ8eW1hcHMucGFub3JhbWEuUGxheWVyPj4gPVxyXG4gICAgdGhpcy5ldmVudE1hbmFnZXIuZ2V0TGF6eUVtaXR0ZXIoJ2RpcmVjdGlvbmNoYW5nZScpO1xyXG5cclxuICAvKipcclxuICAgKiBBbiBlcnJvciBvY2N1cnJlZCBkdXJpbmcgb3BlcmF0aW9uIG9mIHRoZSBwbGF5ZXIuIFRoZSB1c2VyIHdpbGwgYmUgc2hvd24gdGhlIGFwcHJvcHJpYXRlIHNjcmVlbi5cclxuICAgKiB7QGxpbmsgaHR0cHM6Ly95YW5kZXguY29tL2Rldi9tYXBzL2pzYXBpL2RvYy8yLjEvcmVmL3JlZmVyZW5jZS9wYW5vcmFtYS5QbGF5ZXIuaHRtbCNldmVudF9kZXRhaWxfX2V2ZW50LWVycm9yfVxyXG4gICAqL1xyXG4gIEBPdXRwdXQoKSB5YWVycm9yOiBPYnNlcnZhYmxlPFlhRXZlbnQ8eW1hcHMucGFub3JhbWEuUGxheWVyPj4gPVxyXG4gICAgdGhpcy5ldmVudE1hbmFnZXIuZ2V0TGF6eUVtaXR0ZXIoJ2Vycm9yJyk7XHJcblxyXG4gIC8qKlxyXG4gICAqIFRoZSBwYW5vcmFtYSBwbGF5ZXIgc3dpdGNoZWQgdG8gZnVsbC1zY3JlZW4gbW9kZS5cclxuICAgKiB7QGxpbmsgaHR0cHM6Ly95YW5kZXguY29tL2Rldi9tYXBzL2pzYXBpL2RvYy8yLjEvcmVmL3JlZmVyZW5jZS9wYW5vcmFtYS5QbGF5ZXIuaHRtbCNldmVudF9kZXRhaWxfX2V2ZW50LWZ1bGxzY3JlZW5lbnRlcn1cclxuICAgKi9cclxuICBAT3V0cHV0KCkgZnVsbHNjcmVlbmVudGVyOiBPYnNlcnZhYmxlPFlhRXZlbnQ8eW1hcHMucGFub3JhbWEuUGxheWVyPj4gPVxyXG4gICAgdGhpcy5ldmVudE1hbmFnZXIuZ2V0TGF6eUVtaXR0ZXIoJ2Z1bGxzY3JlZW5lbnRlcicpO1xyXG5cclxuICAvKipcclxuICAgKiBUaGUgcGFub3JhbWEgcGxheWVyIGV4aXRlZCBmdWxsLXNjcmVlbiBtb2RlLlxyXG4gICAqIHtAbGluayBodHRwczovL3lhbmRleC5jb20vZGV2L21hcHMvanNhcGkvZG9jLzIuMS9yZWYvcmVmZXJlbmNlL3Bhbm9yYW1hLlBsYXllci5odG1sI2V2ZW50X2RldGFpbF9fZXZlbnQtZnVsbHNjcmVlbmV4aXR9XHJcbiAgICovXHJcbiAgQE91dHB1dCgpIGZ1bGxzY3JlZW5leGl0OiBPYnNlcnZhYmxlPFlhRXZlbnQ8eW1hcHMucGFub3JhbWEuUGxheWVyPj4gPVxyXG4gICAgdGhpcy5ldmVudE1hbmFnZXIuZ2V0TGF6eUVtaXR0ZXIoJ2Z1bGxzY3JlZW5leGl0Jyk7XHJcblxyXG4gIC8qKlxyXG4gICAqIFRoZSB1c2VyIGNsaWNrZWQgb24gYW4gZXhwYW5kZWQgbWFya2VyLlxyXG4gICAqIHtAbGluayBodHRwczovL3lhbmRleC5jb20vZGV2L21hcHMvanNhcGkvZG9jLzIuMS9yZWYvcmVmZXJlbmNlL3Bhbm9yYW1hLlBsYXllci5odG1sI2V2ZW50X2RldGFpbF9fZXZlbnQtbWFya2VyY29sbGFwc2V9XHJcbiAgICovXHJcbiAgQE91dHB1dCgpIG1hcmtlcmNvbGxhcHNlOiBPYnNlcnZhYmxlPFlhRXZlbnQ8eW1hcHMucGFub3JhbWEuUGxheWVyPj4gPVxyXG4gICAgdGhpcy5ldmVudE1hbmFnZXIuZ2V0TGF6eUVtaXR0ZXIoJ21hcmtlcmNvbGxhcHNlJyk7XHJcblxyXG4gIC8qKlxyXG4gICAqIFRoZSB1c2VyIGNsaWNrZWQgb24gYSBjb2xsYXBzZWQgbWFya2VyLlxyXG4gICAqIHtAbGluayBodHRwczovL3lhbmRleC5jb20vZGV2L21hcHMvanNhcGkvZG9jLzIuMS9yZWYvcmVmZXJlbmNlL3Bhbm9yYW1hLlBsYXllci5odG1sI2V2ZW50X2RldGFpbF9fZXZlbnQtbWFya2VyZXhwYW5kfVxyXG4gICAqL1xyXG4gIEBPdXRwdXQoKSBtYXJrZXJleHBhbmQ6IE9ic2VydmFibGU8WWFFdmVudDx5bWFwcy5wYW5vcmFtYS5QbGF5ZXI+PiA9XHJcbiAgICB0aGlzLmV2ZW50TWFuYWdlci5nZXRMYXp5RW1pdHRlcignbWFya2VyZXhwYW5kJyk7XHJcblxyXG4gIC8qKlxyXG4gICAqIFRoZSB1c2VyJ3MgY3Vyc29yIGhvdmVyZWQgb3ZlciBhIG1hcmtlci5cclxuICAgKiB7QGxpbmsgaHR0cHM6Ly95YW5kZXguY29tL2Rldi9tYXBzL2pzYXBpL2RvYy8yLjEvcmVmL3JlZmVyZW5jZS9wYW5vcmFtYS5QbGF5ZXIuaHRtbCNldmVudF9kZXRhaWxfX2V2ZW50LW1hcmtlcm1vdXNlZW50ZXJ9XHJcbiAgICovXHJcbiAgQE91dHB1dCgpIG1hcmtlcm1vdXNlZW50ZXI6IE9ic2VydmFibGU8WWFFdmVudDx5bWFwcy5wYW5vcmFtYS5QbGF5ZXI+PiA9XHJcbiAgICB0aGlzLmV2ZW50TWFuYWdlci5nZXRMYXp5RW1pdHRlcignbWFya2VybW91c2VlbnRlcicpO1xyXG5cclxuICAvKipcclxuICAgKiBUaGUgdXNlcidzIGN1cnNvciBsZWZ0IGEgbWFya2VyLlxyXG4gICAqIHtAbGluayBodHRwczovL3lhbmRleC5jb20vZGV2L21hcHMvanNhcGkvZG9jLzIuMS9yZWYvcmVmZXJlbmNlL3Bhbm9yYW1hLlBsYXllci5odG1sI2V2ZW50X2RldGFpbF9fZXZlbnQtbWFya2VybW91c2VsZWF2ZX1cclxuICAgKi9cclxuICBAT3V0cHV0KCkgbWFya2VybW91c2VsZWF2ZTogT2JzZXJ2YWJsZTxZYUV2ZW50PHltYXBzLnBhbm9yYW1hLlBsYXllcj4+ID1cclxuICAgIHRoaXMuZXZlbnRNYW5hZ2VyLmdldExhenlFbWl0dGVyKCdtYXJrZXJtb3VzZWxlYXZlJyk7XHJcblxyXG4gIC8qKlxyXG4gICAqIFRoZSBvcGVuIHBhbm9yYW1hIGNoYW5nZWQuXHJcbiAgICoge0BsaW5rIGh0dHBzOi8veWFuZGV4LmNvbS9kZXYvbWFwcy9qc2FwaS9kb2MvMi4xL3JlZi9yZWZlcmVuY2UvcGFub3JhbWEuUGxheWVyLmh0bWwjZXZlbnRfZGV0YWlsX19ldmVudC1wYW5vcmFtYWNoYW5nZX1cclxuICAgKi9cclxuICBAT3V0cHV0KCkgcGFub3JhbWFjaGFuZ2U6IE9ic2VydmFibGU8WWFFdmVudDx5bWFwcy5wYW5vcmFtYS5QbGF5ZXI+PiA9XHJcbiAgICB0aGlzLmV2ZW50TWFuYWdlci5nZXRMYXp5RW1pdHRlcigncGFub3JhbWFjaGFuZ2UnKTtcclxuXHJcbiAgLyoqXHJcbiAgICogVGhlIHNpemUgb2YgdGhlIHZpZXdwb3J0IGhhcyBiZWVuIGNoYW5nZWQuXHJcbiAgICoge0BsaW5rIGh0dHBzOi8veWFuZGV4LmNvbS9kZXYvbWFwcy9qc2FwaS9kb2MvMi4xL3JlZi9yZWZlcmVuY2UvcGFub3JhbWEuUGxheWVyLmh0bWwjZXZlbnRfZGV0YWlsX19ldmVudC1zcGFuY2hhbmdlfVxyXG4gICAqL1xyXG4gIEBPdXRwdXQoKSBzcGFuY2hhbmdlOiBPYnNlcnZhYmxlPFlhRXZlbnQ8eW1hcHMucGFub3JhbWEuUGxheWVyPj4gPVxyXG4gICAgdGhpcy5ldmVudE1hbmFnZXIuZ2V0TGF6eUVtaXR0ZXIoJ3NwYW5jaGFuZ2UnKTtcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBuZ1pvbmU6IE5nWm9uZSwgcHJpdmF0ZSByZWFkb25seSB5YU1hcENvbXBvbmVudDogWWFNYXBDb21wb25lbnQpIHt9XHJcblxyXG4gIC8qKlxyXG4gICAqIEhhbmRsZXMgaW5wdXQgY2hhbmdlcyBhbmQgcGFzc2VzIHRoZW0gaW4gQVBJLlxyXG4gICAqIEBwYXJhbSBjaGFuZ2VzXHJcbiAgICovXHJcbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcyk6IHZvaWQge1xyXG4gICAgY29uc3QgeyBwbGF5ZXIgfSA9IHRoaXM7XHJcblxyXG4gICAgaWYgKHBsYXllcikge1xyXG4gICAgICBjb25zdCB7IHBvaW50LCBsYXllciwgb3B0aW9ucyB9ID0gY2hhbmdlcztcclxuXHJcbiAgICAgIC8qKlxyXG4gICAgICAgKiBwbGF5ZXIubW92ZVRvIHJlc2V0cyB2YWx1ZXMgdG8gZGVmYXVsdCBpZiBhbnkgb2YgdGhlbSBpc24ndCBwYXNzZWQuXHJcbiAgICAgICAqIFRoYXQncyB3aHkgd2UgdXNlIHZhbHVlIGZyb20gY3VycmVudFZhbHVlIE9SIHByZXZpb3VzIHZhbHVlIGZyb20gaW5wdXQuXHJcbiAgICAgICAqIFdpdGggdGhhdCBsb2dpYyBpdCdzIHBvc3NpYmxlIHRvIHBhc3Mgb25seSBwb2ludCwgbGF5ZXIgb3Igb3B0aW9ucy5cclxuICAgICAgICovXHJcbiAgICAgIGlmIChwb2ludCB8fCBsYXllcikge1xyXG4gICAgICAgIGNvbnN0IGNvbWJpbmVkUG9pbnQ6IG51bWJlcltdID0gcG9pbnQ/LmN1cnJlbnRWYWx1ZSB8fCB0aGlzLnBvaW50O1xyXG4gICAgICAgIGNvbnN0IGNvbWJpbmVkTGF5ZXI6IHltYXBzLnBhbm9yYW1hLkxheWVyID0gbGF5ZXI/LmN1cnJlbnRWYWx1ZSB8fCB0aGlzLmxheWVyO1xyXG5cclxuICAgICAgICBwbGF5ZXIubW92ZVRvKGNvbWJpbmVkUG9pbnQsIHsgbGF5ZXI6IGNvbWJpbmVkTGF5ZXIgfSk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGlmIChvcHRpb25zKSB7XHJcbiAgICAgICAgdGhpcy5zZXRPcHRpb25zKG9wdGlvbnMuY3VycmVudFZhbHVlLCBwbGF5ZXIpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBuZ09uSW5pdCgpOiB2b2lkIHtcclxuICAgIGNvbnN0IHBhbm9yYW1hJCA9IHRoaXMueWFNYXBDb21wb25lbnQubWFwJC5waXBlKFxyXG4gICAgICBmaWx0ZXIoQm9vbGVhbiksXHJcbiAgICAgIHN3aXRjaE1hcCgobTogeW1hcHMuTWFwKSA9PiB7XHJcbiAgICAgICAgLy8gTWFwIGFuZCBwYW5vcmFtYSB1c2UgdGhlIHNhbWUgY29udGFpbmVyLCBzbyBuZWVkIHRvIGRlc3Ryb3kvcmVtb3ZlIG1hcFxyXG4gICAgICAgIG0uZGVzdHJveSgpO1xyXG4gICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZVBhbm9yYW1hKCk7XHJcbiAgICAgIH0pLFxyXG4gICAgKTtcclxuXHJcbiAgICBwYW5vcmFtYSQucGlwZSh0YWtlKDEpLCB0YWtlVW50aWwodGhpcy5kZXN0cm95JCkpLnN1YnNjcmliZSgocGFub3JhbWEpID0+IHtcclxuICAgICAgY29uc3QgeyBpZCB9ID0gdGhpcy55YU1hcENvbXBvbmVudC5jb250YWluZXIubmF0aXZlRWxlbWVudDtcclxuICAgICAgY29uc3QgcGxheWVyID0gbmV3IHltYXBzLnBhbm9yYW1hLlBsYXllcihpZCwgcGFub3JhbWEsIHRoaXMub3B0aW9ucyk7XHJcbiAgICAgIHRoaXMucGxheWVyID0gcGxheWVyO1xyXG5cclxuICAgICAgdGhpcy5ldmVudE1hbmFnZXIuc2V0VGFyZ2V0KHBsYXllcik7XHJcbiAgICAgIHRoaXMubmdab25lLnJ1bigoKSA9PiB0aGlzLnJlYWR5LmVtaXQoeyB5bWFwcywgdGFyZ2V0OiBwbGF5ZXIgfSkpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcclxuICAgIHRoaXMuZXZlbnRNYW5hZ2VyLmRlc3Ryb3koKTtcclxuICAgIHRoaXMuZGVzdHJveSQubmV4dCgpO1xyXG4gICAgdGhpcy5kZXN0cm95JC5jb21wbGV0ZSgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRGVzdHJ1Y3RzIHN0YXRlIGFuZCBwYXNzZXMgaXQgaW4gQVBJLlxyXG4gICAqIEBwYXJhbSBvcHRpb25zXHJcbiAgICogQHBhcmFtIHBsYXllclxyXG4gICAqL1xyXG4gIHByaXZhdGUgc2V0T3B0aW9ucyhvcHRpb25zOiB5bWFwcy5wYW5vcmFtYS5JUGxheWVyT3B0aW9ucywgcGxheWVyOiB5bWFwcy5wYW5vcmFtYS5QbGF5ZXIpOiB2b2lkIHtcclxuICAgIGNvbnN0IHtcclxuICAgICAgYXV0b0ZpdFRvVmlld3BvcnQsXHJcbiAgICAgIGNvbnRyb2xzLFxyXG4gICAgICBkaXJlY3Rpb24sXHJcbiAgICAgIGhvdGtleXNFbmFibGVkLFxyXG4gICAgICBzcGFuLFxyXG4gICAgICBzY3JvbGxab29tQmVoYXZpb3IsXHJcbiAgICAgIHN1cHByZXNzTWFwT3BlbkJsb2NrLFxyXG4gICAgfSA9IG9wdGlvbnM7XHJcblxyXG4gICAgaWYgKFxyXG4gICAgICBhdXRvRml0VG9WaWV3cG9ydCB8fFxyXG4gICAgICBjb250cm9scyB8fFxyXG4gICAgICBob3RrZXlzRW5hYmxlZCB8fFxyXG4gICAgICBzY3JvbGxab29tQmVoYXZpb3IgfHxcclxuICAgICAgc3VwcHJlc3NNYXBPcGVuQmxvY2tcclxuICAgICkge1xyXG4gICAgICBjb25zb2xlLndhcm4oXHJcbiAgICAgICAgJ09ubHkgZGlyZWN0aW9uIGFuZCBzcGFuIGNhbiBiZSBzZXQgYWZ0ZXIgZW50aXR5IGluaXQuIFRvIHNldCBvdGhlciBvcHRpb25zLCB5b3Ugc2hvdWxkIHJlY3JlYXRlIGEgUGFub3JhbWEgd2l0aCBuZXcgb3B0aW9ucycsXHJcbiAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGRpcmVjdGlvbikge1xyXG4gICAgICBwbGF5ZXIuc2V0RGlyZWN0aW9uKGRpcmVjdGlvbik7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHNwYW4pIHtcclxuICAgICAgcGxheWVyLnNldFNwYW4oc3Bhbik7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTZWFyY2hlcyBmb3IgYSBwYW5vcmFtYSBhbmQgcmV0dXJucyBmaXJzdFxyXG4gICAqL1xyXG4gIHByaXZhdGUgY3JlYXRlUGFub3JhbWEoKTogT2JzZXJ2YWJsZTx5bWFwcy5JUGFub3JhbWE+IHtcclxuICAgIHJldHVybiBmcm9tKHltYXBzLnBhbm9yYW1hLmxvY2F0ZSh0aGlzLnBvaW50LCB7IGxheWVyOiB0aGlzLmxheWVyIH0pKS5waXBlKFxyXG4gICAgICBtYXAoKHBhbm9yYW1hcykgPT4gcGFub3JhbWFzWzBdKSxcclxuICAgICk7XHJcbiAgfVxyXG59XHJcbiJdfQ==